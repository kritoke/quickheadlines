# Bastillefile for quickheadlines (Cross-Platform Fixes)

# 0. Clean up previous failed attempts
CMD service quickheadlines stop 2>/dev/null || true
CMD rm -rf /tmp/qh 2>/dev/null || true

# 1. Install dependencies (including sudo for user switching)
# Note: node/npm not needed - elm.js is pre-compiled in repo
# Note: FreeBSD uses Crystal 1.18.2 from ports (Athena-compatible)
CMD pkg install -y crystal shards git openssl ca_root_nss gmake curl sqlite3 sudo libevent libyaml

# Link SSL certificates (handle different FreeBSD versions)
CMD sh -c "if [ -f /usr/local/share/certs/ca-root-nss.crt ]; then ln -sf /usr/local/share/certs/ca-root-nss.crt /etc/ssl/cert.pem 2>/dev/null || true; elif [ -f /etc/ssl/cert.pem ]; then echo 'SSL cert already linked'; fi"

# 2. Create user and core directories
CMD pw useradd qh -d /usr/local/share/quickheadlines -s /usr/sbin/nologin 2>/dev/null || true
CMD mkdir -p /usr/local/share/quickheadlines /var/cache/quickheadlines /home/qh
CMD chown -R qh:qh /usr/local/share/quickheadlines /var/cache/quickheadlines /home/qh 2>/dev/null || true

# 3. Setup Persistence Cache
# Cache shards lib directory to avoid re-downloading dependencies
FSTAB /usr/local/bastille/cache/crystal/quickheadlines /home/qh/.cache nullfs rw 0 0

# 4. Clone and Prepare Environment
# Configuration via quickheadlines_env variable:
#   QUICKHEADLINES_DEV=1         - Clone main branch for development
#   QUICKHEADLINES_TAG=x.x.x     - Clone specific tag
#   QUICKHEADLINES_REPO_URL=...  - Custom repository URL
CMD rm -rf /tmp/qh 2>/dev/null || true
CMD mkdir -p /tmp/qh
CMD sh -c "if [ -n \"\$QUICKHEADLINES_DEV\" ]; then echo 'DEV mode: Cloning main branch'; REPO_URL=\"\${QUICKHEADLINES_REPO_URL:-https://github.com/kritoke/quickheadlines.git}\"; git clone \$REPO_URL /tmp/qh || { echo 'ERROR: Failed to clone repository'; exit 1; }; elif [ -n \"\$QUICKHEADLINES_TAG\" ]; then echo \"Cloning tag \$QUICKHEADLINES_TAG\"; REPO_URL=\"\${QUICKHEADLINES_REPO_URL:-https://github.com/kritoke/quickheadlines.git}\"; git clone --branch \$QUICKHEADLINES_TAG \$REPO_URL /tmp/qh 2>/dev/null || { echo \"ERROR: Tag \$QUICKHEADLINES_TAG not found\"; exit 1; }; else echo 'PROD mode: Cloning default branch'; REPO_URL=\"\${QUICKHEADLINES_REPO_URL:-https://github.com/kritoke/quickheadlines.git}\"; git clone \$REPO_URL /tmp/qh || { echo 'ERROR: Failed to clone repository'; exit 1; }; fi && chown -R qh:qh /tmp/qh 2>/dev/null || true"

# 5. Build quickheadlines
# elm.js is pre-compiled in repository, so we don't need to compile it on FreeBSD
# Use system Crystal 1.18.2 (Athena-compatible)

# Validate repository was cloned
CMD sh -c "if [ ! -d '/tmp/qh' ] || [ ! -f '/tmp/qh/makefile' ]; then echo 'ERROR: Repository not cloned to /tmp/qh'; exit 1; fi"

# Use system Crystal 1.18.2
CMD sh -c "crystal --version && echo 'Using system Crystal:'"

# Install dependencies
CMD sh -c "cd /tmp/qh && export HOME=/home/qh && echo 'Installing Crystal dependencies...' && sudo -u qh sh -c \"export HOME=/home/qh && shards install\""

# Build or skip based on configuration
CMD sh -c "cd /tmp/qh && export MAKE=gmake && export HOME=/home/qh && if [ -n \"\$QUICKHEADLINES_SKIP_BUILD\" ]; then echo 'SKIP_BUILD mode: Using existing binary'; if [ ! -f '/usr/local/share/quickheadlines/quickheadlines' ]; then echo 'ERROR: SKIP_BUILD specified but no existing binary found'; exit 1; fi; elif [ -f '/usr/local/share/quickheadlines/quickheadlines' ]; then echo 'Existing binary found, skipping build'; else echo 'Building quickheadlines binary...' && sudo -u qh sh -c \"export MAKE=gmake && export HOME=/home/qh && gmake build\" && echo 'Copying binary to installation directory...' && cp bin/quickheadlines /usr/local/share/quickheadlines/ 2>/dev/null || true; fi"

# 6. Install Binary and Config
CMD cp /tmp/qh/bin/quickheadlines /usr/local/share/quickheadlines 2>/dev/null || true
CMD [ ! -f /usr/local/share/quickheadlines/feeds.yml ] && cp /tmp/qh/feeds.yml /usr/local/share/quickheadlines/feeds.yml || true
CMD chown qh:qh /usr/local/share/quickheadlines/quickheadlines /usr/local/share/quickheadlines/feeds.yml 2>/dev/null || true

# 7. Setup Service
CMD cp /tmp/qh/misc/quickheadlines /usr/local/etc/rc.d/quickheadlines 2>/dev/null || true
SYSRC quickheadlines_enable="YES"
CMD chmod +x /usr/local/etc/rc.d/quickheadlines

# 8. Wait for database readiness and start
CMD sleep 2
CMD service quickheadlines start