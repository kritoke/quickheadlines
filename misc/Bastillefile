# Bastillefile for quickheadlines (Cross-Platform Fixes)

# 0. Clean up previous failed attempts
CMD service quickheadlines stop 2>/dev/null || true
CMD rm -rf /tmp/qh 2>/dev/null || true

# 1. Install dependencies (including sudo for user switching)
# Detect available LLVM version (libmagic is in FreeBSD base system)
CMD export LLVM_PKG="llvm19" && \
    for v in 19 18 17 15; do \
        if [ -z "$$LLVM_PKG_INSTALLED" ] && pkg info -e llvm$$v >/dev/null 2>&1; then \
            LLVM_PKG="llvm$$v"; \
            LLVM_PKG_INSTALLED="yes"; \
        fi; \
    done && \
    echo "Using $$LLVM_PKG for LLVM" && \
    pkg install -y crystal shards git openssl ca_root_nss node npm gmake curl sqlite3 sudo $$LLVM_PKG libevent libyaml || \
    (echo "Package install failed, trying without LLVM..." && \
     pkg install -y crystal shards git openssl ca_root_nss node npm gmake curl sqlite3 sudo libevent libyaml)

# Link LLVM-Config (auto-detect version)
CMD if [ -x "/usr/local/bin/llvm-config19" ]; then \
        ln -sf /usr/local/bin/llvm-config19 /usr/local/bin/llvm-config && echo "Linked llvm-config19"; \
    elif [ -x "/usr/local/bin/llvm-config18" ]; then \
        ln -sf /usr/local/bin/llvm-config18 /usr/local/bin/llvm-config && echo "Linked llvm-config18"; \
    elif [ -x "/usr/local/bin/llvm-config17" ]; then \
        ln -sf /usr/local/bin/llvm-config17 /usr/local/bin/llvm-config && echo "Linked llvm-config17"; \
    elif [ -x "/usr/local/bin/llvm-config15" ]; then \
        ln -sf /usr/local/bin/llvm-config15 /usr/local/bin/llvm-config && echo "Linked llvm-config15"; \
    fi

# Link SSL certificates (handle different FreeBSD versions)
CMD if [ -f /usr/local/share/certs/ca-root-nss.crt ]; then \
        ln -sf /usr/local/share/certs/ca-root-nss.crt /etc/ssl/cert.pem 2>/dev/null || true; \
    elif [ -f /etc/ssl/cert.pem ]; then \
        echo "SSL cert already linked"; \
    fi

# 2. Create user and core directories
CMD pw useradd qh -d /usr/local/share/quickheadlines -s /usr/sbin/nologin 2>/dev/null || true
CMD mkdir -p /usr/local/share/quickheadlines /var/cache/quickheadlines /home/qh/.cache/crystal
CMD chown -R qh:qh /usr/local/share/quickheadlines /var/cache/quickheadlines /home/qh 2>/dev/null || true

# 3. Setup Persistent Crystal Cache
FSTAB /usr/local/bastille/cache/crystal/quickheadlines /home/qh/.cache/crystal nullfs rw 0 0

# 4. Clone and Prepare Environment
CMD git clone https://github.com/kritoke/quickheadlines.git /tmp/qh 2>/dev/null || true
CMD chown -R qh:qh /tmp/qh 2>/dev/null || true
CMD sysrc quickheadlines_env="GC_MARKERS=1 GC_FREE_SPACE_DIVISOR=20 QUICKHEADLINES_CACHE_DIR=/var/cache/quickheadlines" 2>/dev/null || true

# 5. Build with explicit GMAKE and auto-detected LLVM
CMD cd /tmp/qh && \
    export PATH=/usr/local/bin:$$PATH && \
    sudo -u qh sh -c "export PATH=/usr/local/bin:\$PATH && npm install @tailwindcss/cli tailwindcss 2>/dev/null || true" && \
    sudo -u qh sh -c "export PATH=/usr/local/bin:\$PATH && gmake shards install CRYSTAL=/usr/local/bin/crystal" && \
    if [ -x "/usr/local/bin/llvm-config" ]; then \
        sudo -u qh sh -c "export PATH=/usr/local/bin:\$PATH && export MAKE=gmake LLVM_CONFIG=/usr/local/bin/llvm-config && gmake build CRYSTAL=/usr/local/bin/crystal"; \
    else \
        sudo -u qh sh -c "export PATH=/usr/local/bin:\$PATH && export MAKE=gmake && gmake build CRYSTAL=/usr/local/bin/crystal"; \
    fi

# 6. Install Binary and Config
CMD cp /tmp/qh/bin/quickheadlines /usr/local/share/quickheadlines 2>/dev/null || true
CMD [ ! -f /usr/local/share/quickheadlines/feeds.yml ] && cp /tmp/qh/feeds.yml /usr/local/share/quickheadlines/feeds.yml || true
CMD chown qh:qh /usr/local/share/quickheadlines/quickheadlines /usr/local/share/quickheadlines/feeds.yml 2>/dev/null || true

# 7. Setup Service
CMD cp /tmp/qh/misc/quickheadlines /usr/local/etc/rc.d/quickheadlines 2>/dev/null || true
SYSRC quickheadlines_enable="YES"
CMD chmod +x /usr/local/etc/rc.d/quickheadlines

# 8. Wait for database readiness and start
CMD sleep 2
CMD service quickheadlines start