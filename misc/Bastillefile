# Bastillefile for quickheadlines (LLVM & GMAKE Fix)

# 0. Clean up previous failed attempts
CMD service quickheadlines stop || true
CMD rm -rf /tmp/qh || true

# 1. Install dependencies
# Added libevent, libyaml, libmagic, and llvm15
PKG crystal shards git openssl ca_root_nss node npm gmake curl sqlite3 llvm15 libevent libyaml

# Link SSL certs and LLVM-Config
CMD ln -sf /usr/local/share/certs/ca-root-nss.crt /etc/ssl/cert.pem
CMD ln -sf /usr/local/bin/llvm-config15 /usr/local/bin/llvm-config

# 2. Create user and core directories
CMD pw useradd qh -d /usr/local/share/quickheadlines -s /usr/sbin/nologin || true
CMD mkdir -p /usr/local/share/quickheadlines /var/cache/quickheadlines /home/qh/.cache/crystal
CMD chown -R qh:qh /usr/local/share/quickheadlines /var/cache/quickheadlines /home/qh

# 3. Setup Persistent Crystal Cache
FSTAB /usr/local/bastille/cache/crystal/quickheadlines /home/qh/.cache/crystal nullfs rw 0 0

# 4. Clone and Prepare Environment
CMD git clone https://github.com/kritoke/quickheadlines.git /tmp/qh
CMD chown -R qh:qh /tmp/qh
CMD sysrc quickheadlines_env="GC_MARKERS=1 GC_FREE_SPACE_DIVISOR=20 QUICKHEADLINES_CACHE_DIR=/var/cache/quickheadlines"

# 5. Build with explicit GMAKE
# We pass MAKE=gmake into the environment so sub-processes don't use BSD make
CMD cd /tmp/qh && su qh -c "npm install @tailwindcss/cli tailwindcss"
CMD cd /tmp/qh && su qh -c "shards install --production"
CMD cd /tmp/qh && su qh -c "gmake build MAKE=gmake CRYSTAL=/usr/local/bin/crystal"

# 6. Install Binary and Config
CMD cp /tmp/qh/bin/quickheadlines /usr/local/share/quickheadlines
CMD [ ! -f /usr/local/share/quickheadlines/feeds.yml ] && cp /tmp/qh/feeds.yml /usr/local/share/quickheadlines/feeds.yml || true
CMD chown qh:qh /usr/local/share/quickheadlines/quickheadlines /usr/local/share/quickheadlines/feeds.yml

# 7. Setup Service
CMD cp /tmp/qh/misc/quickheadlines /usr/local/etc/rc.d/quickheadlines
SYSRC quickheadlines_enable="YES"
CMD chmod +x /usr/local/etc/rc.d/quickheadlines

# 8. Cleanup and Start
CMD rm -rf /tmp/qh
CMD service quickheadlines start