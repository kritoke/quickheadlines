# Bastillefile for quickheadlines (Cross-Platform Fixes)

# 0. Clean up previous failed attempts
CMD service quickheadlines stop 2>/dev/null || true
CMD rm -rf /tmp/qh 2>/dev/null || true

# 1. Install dependencies (including sudo for user switching)
# Note: node/npm not needed - elm.js is pre-compiled in the repo
# Note: FreeBSD uses Crystal from ports (1.8.2) instead of 1.19.1 which isn't available
CMD pkg install -y crystal shards git openssl ca_root_nss gmake curl sqlite3 sudo libevent libyaml || \
    (echo "Package install failed..." && exit 1)

# Link SSL certificates (handle different FreeBSD versions)
CMD if [ -f /usr/local/share/certs/ca-root-nss.crt ]; then \
        ln -sf /usr/local/share/certs/ca-root-nss.crt /etc/ssl/cert.pem 2>/dev/null || true; \
    elif [ -f /etc/ssl/cert.pem ]; then \
        echo "SSL cert already linked"; \
    fi

# 2. Create user and core directories
CMD pw useradd qh -d /usr/local/share/quickheadlines -s /usr/sbin/nologin 2>/dev/null || true
CMD mkdir -p /usr/local/share/quickheadlines /var/cache/quickheadlines /home/qh
CMD chown -R qh:qh /usr/local/share/quickheadlines /var/cache/quickheadlines /home/qh 2>/dev/null || true

# 3. Setup Persistence Cache
# Cache shards lib directory to avoid re-downloading dependencies
FSTAB /usr/local/bastille/cache/crystal/quickheadlines /home/qh/.cache nullfs rw 0 0

# 4. Clone and Prepare Environment
CMD git clone https://github.com/kritoke/quickheadlines.git /tmp/qh 2>/dev/null || true
CMD chown -R qh:qh /tmp/qh 2>/dev/null || true
CMD sysrc quickheadlines_env="GC_MARKERS=1 GC_FREE_SPACE_DIVISOR=20 QUICKHEADLINES_CACHE_DIR=/var/cache/quickheadlines" 2>/dev/null || true

# 5. Build quickheadlines
# elm.js is pre-compiled in the repository, so we don't need to compile it on FreeBSD
# Crystal 1.18.2 (from Freshports) builds Crystal 1.19.1 from source
CMD cd /tmp/qh && \
    export PATH=/usr/local/bin:/usr/bin:/bin:$$PATH && \
    export MAKE=gmake && \
    echo "Checking system Crystal 1.18.2 from ports..." && \
    if [ -x "/usr/local/bin/crystal" ]; then \
        echo "Found Crystal:" && \
        /usr/local/bin/crystal --version; \
    elif [ -x "/usr/bin/crystal" ]; then \
        echo "Found Crystal:" && \
        /usr/bin/crystal --version; \
    else \
        echo "ERROR: Crystal not found"; \
        exit 1; \
    fi && \
    echo "Building Crystal 1.19.1 from source (30-60 minutes)..." && \
    sudo -u qh sh -c "export PATH=/usr/local/bin:/usr/bin:/bin:\$PATH && export MAKE=gmake && gmake download-crystal" && \
    echo "Crystal 1.19.1 built, checking..." && \
    CRYSTAL_VER=$$(/usr/local/bin/crystal --version 2>/dev/null || echo "unknown") && \
    if [ "$$CRYSTAL_VER" != "Crystal 1.19.1" ]; then \
        echo "ERROR: Crystal version mismatch. Got: $$CRYSTAL_VER, Expected: Crystal 1.19.1"; \
        exit 1; \
    fi && \
    echo "Installing Crystal dependencies..." && \
    sudo -u qh sh -c "export PATH=/tmp/qh/bin:/usr/local/bin:/usr/bin:/bin:\$PATH && shards install" && \
    if [ -n "$$QUICKHEADLINES_SKIP_BUILD" ]; then \
        echo "SKIP_BUILD mode: Using existing binary"; \
    elif [ -f "/usr/local/share/quickheadlines/quickheadlines" ]; then \
        echo "Existing binary found, skipping build"; \
    else \
        echo "Building quickheadlines binary..." && \
        sudo -u qh sh -c "export PATH=/tmp/qh/bin:/usr/local/bin:/usr/bin:/bin:\$PATH && export MAKE=gmake && gmake build"; \
    fi

# 6. Install Binary and Config
CMD cp /tmp/qh/bin/quickheadlines /usr/local/share/quickheadlines 2>/dev/null || true
CMD [ ! -f /usr/local/share/quickheadlines/feeds.yml ] && cp /tmp/qh/feeds.yml /usr/local/share/quickheadlines/feeds.yml || true
CMD chown qh:qh /usr/local/share/quickheadlines/quickheadlines /usr/local/share/quickheadlines/feeds.yml 2>/dev/null || true

# 7. Setup Service
CMD cp /tmp/qh/misc/quickheadlines /usr/local/etc/rc.d/quickheadlines 2>/dev/null || true
SYSRC quickheadlines_enable="YES"
CMD chmod +x /usr/local/etc/rc.d/quickheadlines

# 8. Wait for database readiness and start
CMD sleep 2
CMD service quickheadlines start