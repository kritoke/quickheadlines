## Context

The current clustering system in QuickHeadlines uses direct similarity computation (Jaccard + word coverage) for story clustering. This approach requires computing similarity against all candidate items, resulting in O(n) complexity per clustering operation. As the number of stories grows, this becomes a bottleneck.

The lexis-minhash shard (version ~> 0.1.0) provides:
- MinHash signature computation for documents
- Locality-Sensitive Hashing (LSH) using bands for O(1) candidate discovery
- Approximate Jaccard similarity estimation from MinHash signatures

The shard is now more robust and production-ready.

## Goals / Non-Goals

**Goals:**
- Replace O(n) similarity search with O(1) LSH-based candidate discovery
- Use MinHash signatures for approximate similarity estimation
- Maintain existing clustering behavior (same clusters, just more efficient)
- Integrate lexis-minhash as a dependency

**Non-Goals:**
- Changing clustering thresholds or quality metrics
- Modifying the clustering API or data structures
- Adding new clustering algorithms beyond MinHash/LSH

## Decisions

### 1. Use LexisMinhash::SimpleDocument for text input
**Rationale:** The lexis-minhash shard provides a SimpleDocument class that handles text normalization, shingling, and stop-word filtering internally. This reduces code duplication vs. re-implementing these in ClusteringUtilities.

**Alternatives considered:**
- Implement custom normalization in ClusteringService → More code, higher maintenance
- Use LexisMinhash::Document with custom tokenizer → Unnecessary complexity for headlines

### 2. Store MinHash signatures as BLOB in database
**Rationale:** LexisMinhash::Engine provides signature_to_bytes/bytes_to_signature for serialization. Storing as BLOB allows efficient binary storage and retrieval.

**Alternatives considered:**
- Store as JSON array of integers → More space, slower serialization
- Store LSH bands only → Would need to recompute signatures for similarity estimation

### 3. Replace ClusteringUtilities.hybrid_similarity with LexisMinhash::Engine.similarity
**Rationale:** MinHash provides a well-founded approximation of Jaccard similarity. The LSH bands (generated by LexisMinhash::Engine) allow O(1) candidate discovery by finding items with overlapping bands.

**Alternatives considered:**
- Keep hybrid_similarity for final verification → Adds complexity without clear benefit
- Use MinHash only for candidate discovery, hybrid for final → Hybrid already approximates Jaccard

### 4. Add LSH band index to FeedCache
**Rationale:** LSH bands need to be indexed to find candidates quickly. FeedCache will maintain a band → item_ids mapping in memory (similar to existing keyword index).

**Alternatives considered:**
- Store LSH bands in database → Slower queries, more complex schema
- Recompute bands from signatures → Inefficient, defeats purpose of LSH

### 5. Keep existing word count filtering
**Rationale:** Short headlines (< 5 words) produce unreliable MinHash signatures due to limited shingles. Existing filtering prevents clustering on generic terms.

**Alternatives considered:**
- Remove word count filter → Would cluster generic headlines incorrectly
- Adjust threshold → Current 5-word threshold is already validated

## Risks / Trade-offs

**Risk: MinHash approximation errors**
- MinHash estimates Jaccard similarity with some variance; rare false positives/negatives possible
- Mitigation: Use 100 hash functions (lexis-minhash default) for good accuracy; similarity threshold remains 0.75 (validated)

**Risk: LSH parameter sensitivity**
- Band/row count affects recall/precision trade-off
- Mitigation: Use lexis-minhash defaults (20 bands, 5 rows per band) - proven effective for document similarity

**Risk: Database migration for minhash_signature column**
- Existing items table may not have the column
- Mitigation: Add migration script to ALTER TABLE items ADD COLUMN minhash_signature BLOB; default to NULL (safe)

**Trade-off: Approximate vs. exact similarity**
- MinHash is approximate; hybrid_similarity was exact Jaccard
- Benefit: O(n) → O(1) performance outweighs small approximation error

## Migration Plan

1. Add lexis-minhash dependency to shard.yml and run shards install
2. Create database migration to add minhash_signature column (if missing)
3. Update ClusteringService.compute_cluster_for_item to use LexisMinhash::Engine
4. Update FeedCache to store/retrieve MinHash signatures and LSH bands
5. Test clustering with sample headlines to verify quality
6. Deploy and monitor clustering results

**Rollback strategy:**
- Keep old ClusteringUtilities.hybrid_similarity code commented out
- Revert code changes and remove lexis-minhash dependency if issues arise
- Database migration is backward compatible (NULL values allowed)

## Open Questions

None - design decisions are clear based on lexis-minhash API and existing clustering system.
