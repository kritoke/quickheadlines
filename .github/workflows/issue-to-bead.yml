name: Mobile to Beads JSONL
on:
  issues:
    types: [opened, labeled, reopened]

jobs:
  sync-to-beads:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'bead')
    permissions:
      contents: write
      issues: read
    steps:
      - name: Checkout Beads Sync Branch
        uses: actions/checkout@v4
        with:
          ref: 'beads-sync'
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Create JSONL Bead
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          PREFIX="quickheadlines-"
          ID="${{ github.event.issue.number }}"
          FULL_ID="${PREFIX}${ID}"
          CREATED=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          mkdir -p .beads
          
          # Create compact JSON
          jq -n -c \
            --arg id "$FULL_ID" \
            --arg title "$ISSUE_TITLE" \
            --arg desc "$ISSUE_BODY" \
            --arg status "open" \
            --arg created "$CREATED" \
            '{id: $id, title: $title, description: $desc, status: $status, created_at: $created}' \
            > ".beads/bead-${ID}.jsonl"

      - name: Validate JSONL Integrity
        run: |
          ID="${{ github.event.issue.number }}"
          FILE=".beads/bead-${ID}.jsonl"
          
          echo "Verifying $FILE..."
          # Attempt to parse the file; if it's invalid, jq returns a non-zero exit code
          if jq . "$FILE" > /dev/null; then
            echo "✅ JSON is valid and safe to push."
          else
            echo "❌ JSON validation FAILED. Blocking push to prevent sync corruption."
            exit 1
          fi

      - name: Force Push to beads-sync
        run: |
          git add -f .beads/bead-*.jsonl
          if ! git diff --cached --quiet; then
            git commit -m "feat: sync mobile bead #${{ github.event.issue.number }}"
            git pull --rebase origin beads-sync
            git push origin beads-sync
          else
            echo "No changes detected, skipping push."
          fi
