name: Mobile to Beads JSONL
on:
  issues:
    types: [opened, labeled, reopened]

jobs:
  sync-to-beads:
    runs-on: ubuntu-latest
    # Only run if the 'bead' label is applied
    if: contains(github.event.issue.labels.*.name, 'bead')
    steps:
      - name: Checkout Beads Sync Branch
        uses: actions/checkout@v4
        with:
          # Directly target the branch Beads uses for its SQLite data
          ref: 'beads-sync'
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Create JSONL Bead
        run: |
          # Use jq to handle special characters in the title/body safely for JSON
          TITLE=$(echo "${{ github.event.issue.title }}" | jq -R .)
          BODY=$(echo "${{ github.event.issue.body }}" | jq -R .)
          ID="${{ github.event.issue.number }}"
          CREATED=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          mkdir -p .beads
          # Create a single line JSON file for the SQLite importer
          echo "{\"id\":$ID,\"title\":$TITLE,\"description\":$BODY,\"status\":\"todo\",\"created_at\":\"$CREATED\"}" > ".beads/bead-${ID}.jsonl"

      - name: Push to beads-sync
        run: |
          git add -f .beads/bead-*.jsonl
          if ! git diff --cached --quiet; then
            git commit -m "feat: mobile jsonl bead #${{ github.event.issue.number }}"
            git push origin beads-sync
          else
            echo "No changes detected, skipping push."
          fi

      - name: Confirmation Comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "âœ… **JSONL Created!** Task is now on the \`beads-sync\` branch. Run \`bd-sync-all\` at your desk."
