<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickHeadlines</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }
    #app { width: 100vw; height: 100vh; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
</head>
<body>
  <div id="app"></div>
  <script src="/elm.js"></script>
  <script>
    window.feedHeaderCache = window.feedHeaderCache || {};

    window.extractHeaderColors = function() {
      if (typeof ColorThief === 'undefined') return;
      const colorThief = new ColorThief();

      document.querySelectorAll('.feed-header').forEach(header => {
        const link = header.querySelector('a');
        const feedUrl = link ? link.href : null;

        if (feedUrl && window.feedHeaderCache[feedUrl]) {
          const cached = window.feedHeaderCache[feedUrl];
          header.style.backgroundColor = cached.bg;
          header.style.color = cached.text;
          if (link) link.style.color = cached.text;
          return;
        }

        let img = header.querySelector('img');
        if (!img || !img.getAttribute('src')) return;

        const proxy = new Image();
        proxy.crossOrigin = 'Anonymous';
        if (img.src.startsWith('data:') || img.src.startsWith('/favicons/')) {
          proxy.src = img.src;
        } else {
          proxy.src = img.src;
        }

        proxy.onload = function() {
          try {
            const palette = colorThief.getPalette(proxy, 5);
            if (!palette || !palette.length) return;

            let color = palette[0];

            const isGrayscale = (c) => {
              const max = Math.max(c[0], c[1], c[2]);
              const min = Math.min(c[0], c[1], c[2]);
              return (max - min) < 30;
            };

            if (isGrayscale(color)) {
              for (let i = 1; i < palette.length; i++) {
                if (!isGrayscale(palette[i])) {
                  color = palette[i];
                  break;
                }
              }
            }

            const [r, g, b] = color;
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            const textColor = (yiq >= 128) ? '#1f2937' : '#ffffff';
            const bgColor = 'rgb(' + r + ',' + g + ',' + b + ')';

            header.style.backgroundColor = bgColor;
            header.style.color = textColor;
            if (link) link.style.color = textColor;

            if (feedUrl) {
              window.feedHeaderCache[feedUrl] = { bg: bgColor, text: textColor };
            }
          } catch (e) {}
        };
      });
    };

    (function() {
      var appElement = document.getElementById('app');
      if (!appElement) {
        console.error('app element not found');
        return;
      }

      var savedTheme = localStorage.getItem('quickheadlines-theme');
      var prefersDark = false;
      if (savedTheme) {
        prefersDark = savedTheme === 'dark';
      } else {
        prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      }

      try {
        var app = Elm.Main.init({
          node: appElement,
          flags: {
            width: window.innerWidth,
            height: window.innerHeight,
            prefersDark: prefersDark
          }
        });

        if (app.ports && app.ports.saveTheme) {
          app.ports.saveTheme.subscribe(function(theme) {
            localStorage.setItem('quickheadlines-theme', theme);
          });
        }

        window.addEventListener('resize', function() {
          // Handle resize if needed
        });

        // Extract colors after Elm renders
        setTimeout(window.extractHeaderColors, 500);

      } catch(e) {
        console.error('Elm init error:', e);
        appElement.innerHTML = '<p style="color: red;">Error: ' + e.message + '</p>';
      }
    })();
  </script>
</body>
</html>
