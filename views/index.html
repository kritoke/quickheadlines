<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickHeadlines</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }
    #app { width: 100vw; height: 100vh; }
    .feed-header { transition: background-color 0.3s ease, color 0.3s ease; }
    [data-timeline-header="true"] {
      background-color: transparent !important;
      background: transparent !important;
      font-size: 1.25rem !important; /* 20px equivalent */
      font-weight: bold;
      -webkit-text-size-adjust: none;
    }
    [data-timeline-page="true"] [data-adaptive]:not(.feed-header) {
      background-color: transparent !important;
      background: transparent !important;
      color: inherit !important;
    }
    [data-timeline-page="true"] [data-adaptive]:not(.feed-header) a {
      color: inherit !important;
      text-decoration: underline !important;
    }
    [data-timeline-item="true"] {
      background-color: transparent !important;
      background: transparent !important;
      color: inherit !important;
    }
    [data-timeline-item="true"] a {
      color: inherit !important;
      text-decoration: underline !important;
    }
    [data-display-link="true"] {
      color: inherit !important;
    }
    .feed-header a {
      color: inherit !important;
      text-decoration: underline;
    }
    @media only screen and (max-width: 768px) {
      [data-timeline-header="true"] {
        font-size: 1.125rem !important; /* 18px equivalent */
      }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>
</head>
<body>
  <div id="app"></div>
  <script src="/elm.js"></script>
  <script>
    window.feedHeaderCache = window.feedHeaderCache || {};

    window.extractHeaderColors = function() {
      if (typeof ColorThief === 'undefined') return;
      const colorThief = new ColorThief();

      document.querySelectorAll('.feed-header[data-use-adaptive-colors="true"]').forEach(header => {
        // Skip if already processed
        if (header.dataset.adaptive === 'true') return;

        // Skip timeline headers explicitly - they should never be colored
        if (header.dataset.timelineHeader === 'true') {
          header.dataset.adaptive = 'true';
          return;
        }

        // Ensure element has .feed-header class (defense in depth)
        if (!header.classList.contains('feed-header')) {
          return;
        }

        // Use favicon src as cache key (more reliable than URL matching)
        const img = header.querySelector('img');
        const imgSrc = img ? img.getAttribute('src') : null;
        const faviconKey = imgSrc || 'default';

        // Check cache by favicon path
        if (window.feedHeaderCache[faviconKey]) {
          const cached = window.feedHeaderCache[faviconKey];
          header.style.backgroundColor = cached.bg;
          header.style.color = cached.text;
          const link = header.querySelector('a');
          if (link) {
            link.style.setProperty('color', cached.text, 'important');
            link.style.textDecoration = 'none';
          }
          header.dataset.adaptive = 'true';
          return;
        }

        // Search for image in the header row
        if (!img) return;
        if (!imgSrc) return;

        const proxy = new Image();
        proxy.crossOrigin = 'Anonymous';
        proxy.src = imgSrc;

        proxy.onload = function() {
          try {
            const palette = colorThief.getPalette(proxy, 5);
            if (!palette || !palette.length) return;

            let color = palette[0];

            const isGrayscale = (c) => {
              const max = Math.max(c[0], c[1], c[2]);
              const min = Math.min(c[0], c[1], c[2]);
              return (max - min) < 30;
            };

            if (isGrayscale(color)) {
              for (let i = 1; i < palette.length; i++) {
                if (!isGrayscale(palette[i])) {
                  color = palette[i];
                  break;
                }
              }
            }

            const [r, g, b] = color;
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            const textColor = (yiq >= 128) ? '#1f2937' : '#ffffff';
            const bgColor = 'rgb(' + r + ',' + g + ',' + b + ')';
            const link = header.querySelector('a');

            header.style.backgroundColor = bgColor;
            header.style.color = textColor;
            if (link) {
              link.style.setProperty('color', textColor, 'important');
              link.style.textDecoration = 'none';
            }

            // Store by favicon key for reliable cache lookup
            if (faviconKey) {
              window.feedHeaderCache[faviconKey] = { bg: bgColor, text: textColor };
            }

            // Save extracted colors to database using feed URL if available
            const feedUrl = link ? link.href : null;
            if (feedUrl) {
              fetch('/api/header_color', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ feed_url: feedUrl, color: bgColor, text_color: textColor })
              }).catch(e => {});
            }

            header.dataset.adaptive = 'true';
          } catch (e) {}
        };
      });
    };

    (function() {
      var appElement = document.getElementById('app');
      if (!appElement) {
        console.error('app element not found');
        return;
      }

      var savedTheme = localStorage.getItem('quickheadlines-theme');
      var prefersDark = false;
      if (savedTheme) {
        prefersDark = savedTheme === 'dark';
      } else {
        prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      }

      try {
        var app = Elm.Main.init({
          node: appElement,
          flags: {
            width: window.innerWidth,
            height: window.innerHeight,
            prefersDark: prefersDark
          }
        });

        if (app.ports && app.ports.saveTheme) {
          app.ports.saveTheme.subscribe(function(theme) {
            localStorage.setItem('quickheadlines-theme', theme);
          });
        }

        window.addEventListener('resize', function() {
          // Handle resize if needed
        });

        // Extract colors after Elm renders
        setTimeout(window.extractHeaderColors, 500);
        setTimeout(window.extractHeaderColors, 1500);

        // Observe DOM for new feed headers (after tab switch, etc.)
        const observer = new MutationObserver(() => {
          window.extractHeaderColors();
        });
        observer.observe(document.body, { childList: true, subtree: true });

      } catch(e) {
        console.error('Elm init error:', e);
        appElement.innerHTML = '<p style="color: red;">Error: ' + e.message + '</p>';
      }
    })();
  </script>
</body>
</html>
